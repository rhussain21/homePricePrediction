---
title: "Lab2"
output: pdf_document
date: '2022-04-03'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r add libraries, echo = FALSE, warning=FALSE, message = FALSE}

library(tidyverse)
library(ggplot2)
library(stargazer)


```


```{r read data, echo = FALSE, message = FALSE, warning=FALSE}

#initial read. Skip lines with metadata
qns <- read.csv('./2019_queens.csv', skip = 4)
bk <- read.csv('./2019_brooklyn.csv', skip = 4)
bx <- read.csv('./2019_bronx.csv', skip = 4)
mn <- read.csv('./2019_manhattan.csv', skip = 4)
si <- read.csv('./2019_statenisland.csv', skip = 4)
census <- read.csv('./ACSST5Y2019.S1903_data_with_overlays_2021-12-10T101330.csv', skip =1)

#combine borough-level df into single df
ls <- list(qns, bk, bx, mn, si)
df <- do.call("rbind", ls)


#Remove commas from numerical values and convert to numeric type
df$SALE.PRICE. <- as.numeric(gsub(",","",df$SALE.PRICE.))
df$GROSS.SQUARE.FEET. <- as.numeric(gsub(",","",df$GROSS.SQUARE.FEET.))

#parse and format zip code and median income from census data
incomes <- census %>%
  select(Geographic.Area.Name, names(census)[163]) %>%
  separate(col = Geographic.Area.Name, into = c('remove', 'zipcode'), sep = " ") %>%
  select(-1) %>%
  rename('median.income' = 2)  %>%
  lapply(as.integer)


#Left join sales data with income by zipcode

df <- rename(df, zipcode = ZIP.CODE.)
df <- merge(df, incomes, by = 'zipcode', all.x = TRUE)

# Filter for two-dwelling house and rename columns
df <- df %>%
  filter(BUILDING.CLASS.CATEGORY. == '02 TWO FAMILY DWELLINGS',
         SALE.PRICE. > 400000,
         GROSS.SQUARE.FEET. > 500) %>%
  rename(c(sqft = GROSS.SQUARE.FEET., commercial.units = COMMERCIAL.UNITS., 
           boro = BOROUGH., sale.price = SALE.PRICE.))


#covert datatypes




df$commercial.units <- as.factor(df$commercial.units )
df$zipcode <- as.factor(df$zipcode)

#change Borough codes into Borough names
df$boro <- as.factor(plyr::mapvalues(df$boro,c(1,2,3,4,5), 
                                     c("Manhattan", "Bronx", "Brooklyn",  
                                       "Queens", "Staten Island") ))

#create age variable for further evaluation
df$age <- 2019 - df$YEAR.BUILT.


df <- df %>%
  select(zipcode, boro, commercial.units, sqft, sale.price, median.income, age)
df <- na.omit(df)

#Split dataset 30% for EDA and remaining 70% for model testing
#for EDA

set.seed(12345)
samplesize <- round(nrow(df)*(.3))
df_EDA <- df[sample(nrow(df), size = samplesize, replace = FALSE), ]

#for modeling
df_test <- setdiff(df, df_EDA)
```

```{r, Exploratory Data Analysis Fig 1}
theme_set(theme(plot.title = element_text(hjust = 0.5), text = element_text(size=14)))

# overall distribution of sale price 

df_EDA %>% 
  ggplot(aes(x = sale.price))+
  geom_histogram(fill="#5297cc", colour='black') +
  ggtitle("Distribution of Sale Price")

df_EDA %>% 
  ggplot(aes(x = log(sale.price)))+
  geom_histogram(fill="#5297cc", colour='black') +
  ggtitle("Distribution of Sale Price")
```


```{r, Exploratory Data Analysis Fig 4}
# Sale Price Distribution by borough
df_EDA %>% 
  ggplot(aes(x = log(sale.price)))+
  geom_histogram(fill="#5297cc", colour='black', bin=30)+
  facet_grid(rows = vars (boro))+
  ggtitle("Distribution of Sale Prices by Borough")
```

```{r, Exploratory Data Analysis Fig 3}
#price in commercial vs non commercial unit
df_EDA  %>% 
  ggplot(aes(x = log(sale.price)))+
  geom_histogram(bins = 50, fill="#5297cc", colour='black')+
  facet_grid(rows = vars(commercial.units))+
  ggtitle("Sale Price of Two-Family Dwellings with and w/o Commercial Units")

df_EDA %>%
  ggplot() + 
  aes(x = commercial.units, y =log(sale.price), color=commercial.units) +
  geom_point() +
  labs(
    title = 'Fig 7. Square footage vs Sale Price',
    color = 'Commercial units',
  )

```


```{r, Exploratory Data Analysis Fig 5}
# % (log10) unit change sqft vs % change in sqft. facet by commercial vs non commercial unit

df_EDA %>% 
  ggplot(aes(x = sqft))+
  geom_histogram(fill="#5297cc", colour='black') +
  ggtitle("Fig 5. Distribution of Square footage")

df_EDA %>% 
  ggplot(aes(x = log(sqft)))+
  geom_histogram(fill="#5297cc", colour='black') +
  ggtitle("Fig 6. Distribution of Square footage")

df_EDA %>%
  ggplot() + 
  aes(x = log(sqft), y =log(sale.price), color=commercial.units) +
  geom_point() +
  labs(
    title = 'Fig 7. Square footage vs Sale Price',
    color = 'Commercial units',
  )

```  

```{r, Exploratory Data Analysis Fig 8 and Fig 9}
#distribution of age

df_EDA  %>% 
  ggplot(aes(x = (age)))+
  geom_histogram(fill="#5297cc", colour='black')+
  ggtitle("Fig 8. Distribution of Property Age")

df_EDA %>%
  ggplot() + 
  aes(x = age, y =log(sale.price), color=commercial.units) +
  geom_point() +
  labs(
    title = 'Fig 9. Age vs Sale Price',
    color = 'Commercial units',
  )

df_EDA %>%
  ggplot() + 
  aes(x =log(sqft), y =log(sale.price), color=commercial.units) +
  geom_jitter(alpha = 0.5) +
  facet_grid(rows = vars(commercial.units))+
  ggtitle("Sale Price vs. Square Footage by Commercial Units")
```

```{r, Exploratory Data Analysis Fig 6}
#distribution of median income

df_EDA  %>% 
  ggplot(aes(x = (median.income)))+
  geom_histogram()+
  ggtitle("Fig 6. Distribution of Median Income")
```

```{r, Exploratory Data Analysis Fig 7}
#distribution of median income on log scale. The distribution is about the same
#so no transformation would be necessary
df_EDA  %>% 
  ggplot(aes(x = (median.income)))+
  geom_histogram(fill="#5297cc", colour='black')+
  ggtitle("Fig 10. Distribution of % Change in Median Income")

df_EDA  %>% 
  ggplot(aes(x = (median.income)))+
  geom_histogram(fill="#5297cc", colour='black')+
  facet_grid(rows = vars(boro))+
  ggtitle("Distribution of Median Income per Borough")
```


**3. Modeling

***3.1 Base Model



$$sale\_price =  \beta_0 + \beta_1commecial\_units$$

***3.2 Second Model

$$sale\_price =  \beta_0 + \beta_1commecial\_units + \beta_2ln(square\_footage)$$
***3.3 Thrid Model
$$sale\_price =  \beta_0 + \beta_1commecial\_units + \beta_2ln(square\_footage) + \beta_3(property\_age)$$
***3.3 Fourth Model
$$sale\_price =  \beta_0 + \beta_1commecial\_units + \beta_2ln(square\_footage) + \beta_3(property\_age) + \beta_3(median\_income)$$

```{r results = "asis"}

model1 <- lm(log(sale.price) ~ commercial.units, data = df_test)
model2 <- lm(log(sale.price) ~ commercial.units + log(sqft), data = df_test)
model3 <- lm(log(sale.price) ~ commercial.units + log(sqft) + age, data = df_test)
model4 <- lm(log(sale.price) ~ commercial.units + log(sqft) + age + median.income, data = df_test)
model5 <- lm(log(sale.price) ~ commercial.units + log(sqft) + age + median.income + boro, data = df_test)

stargazer(
  model1, model2, model3, model4, model5,
    se = list(
    sqrt(diag(vcovHC(model1))),
    sqrt(diag(vcovHC(model2))),
    sqrt(diag(vcovHC(model3))),
    sqrt(diag(vcovHC(model4))),
    sqrt(diag(vcovHC(model5)))),
  type = 'latex'
)
```

```{r, test model}
anova(model1, model2, test = 'F')
anova(model2, model3, test = 'F')
anova(model3, model4, test = 'F')
anova(model4, model5, test = 'F')

plot(model5, which = 1)
plot(model5, which = 2)
plot(model5, which = 3)
plot(model5, which = 4)
df_test$res <- model5$residuals
```
